---
title: UNIT09Cï¼šå¤šé‡ç·šæ€§å›æ­¸ Multiple Linear Regression
author: ä¸­å±±å¤§å­¸ç®¡ç†å­¸é™¢ å“é›ç„¶
date: "`r Sys.time()`"
output: 
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
---

```{r results='hide', message=FALSE, warning=FALSE, echo=F}
# Formating Codes.  Do not change the codes in this chunk !!
rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE)
par(cex=0.8)
options(scipen=20, digits=5, width=80)
if(!require(pacman)) install.packages("pacman")
```
<hr>

```{r results='hide', message=FALSE, warning=FALSE}
pacman::p_load(dplyr, ggplot2, corrplot)
```
<br><hr>

### [A] å¤šå…ƒç·šæ€§å›æ­¸ - `lm()` 

##### Â§ A1 è®€é€²è³‡æ–™
å…¨çƒæš–åŒ–è³‡æ–™é›†
```{r}
D = read.csv('data/climate_change.csv')
head(D)
```

ç¾ä»£çš„è³‡æ–™åˆ†æéç¨‹ä¹‹ä¸­ï¼Œæˆ‘å€‘é€šå¸¸ä¸æœƒå°‡æ‰€æœ‰çš„è³‡æ–™æ‹¿ä¾†åšæ¨¡å‹ï¼Œè€Œæ˜¯æœƒå…ˆä¿ç•™ä¸€éƒ¨åˆ†çš„è³‡æ–™ä¸‹ä¾†ï¼Œç”¨ä¾†ä¼°è¨ˆæ¨¡å‹çš„æº–ç¢ºæ€§ã€‚æ‰€ä»¥ä¸€é–‹å§‹æˆ‘å€‘æœƒå°‡å…¨éƒ¨è³‡æ–™(`D`)åˆ†å‰²ç‚ºè¨“ç·´è³‡æ–™(`TR`)èˆ‡æ¸¬è©¦è³‡æ–™(`TS`)
```{r}
TR = subset(D, Year <= 2006)  # Train Data
TS = subset(D, Year > 2006)   # Test Data
```


##### Â§ A2 å»ºç«‹æ¨¡å‹
ä½¿ç”¨è¨“ç·´è³‡æ–™(`TR`)åšæ¨¡å‹
```{r}
m1 = lm(Temp~MEI+CO2+CH4+N2O+CFC.11+CFC.12+TSI+Aerosols,TR)
```

##### Â§ A3 æ¨¡å‹æ‘˜è¦
```{r}
options(digits=4, scipen=10)
summary(m1)
```

$y$ çš„ __é æ¸¬å€¼__ï¼š 

+ $\hat{y} = b_0 + b_1 x_1 + b_2 x_2 + b_3 x_3 + b_4 x_4 + ...$

__ç°¡å–®è¬›__ï¼Œå°æ¯ä¸€å€‹è‡ªè®Šæ•¸è€Œè¨€ï¼š

+ $b_i$ : ä¿‚æ•¸çš„ä¼°è¨ˆå€¼ä»£è¡¨ $x_i$ å° $y$ çš„é‚Šéš›æ•ˆæœ
+ $\sigma_i$ : ä¿‚æ•¸çš„æ¨™æº–å·®ä»£è¡¨è©²ä¿‚æ•¸çš„ä¸ç¢ºå®šæ€§
+ $p_i$ : $p$-value å¤§è‡´ä¸Šä»£è¡¨ $x_i$ èˆ‡ $y_i$ ä¹‹é–“æ²’æœ‰é—œä¿‚çš„æ©Ÿç‡ï¼Œ
é€™å€‹æ©Ÿç‡å°æ–¼é¡¯è‘—æ°´æº–ï¼Œæˆ‘å€‘å°±èªª $x_i$ å° $y$ çš„é—œä¿‚æ˜¯é¡¯è‘—çš„

__åš´æ ¼ä¾†è¬›__ï¼š

+ å•é¡Œå¾ˆå¤š ... æ•´å€‹ç®¡çµ±ã€å¤šè®Šé‡ã€å’Œè¨ˆé‡ç¶“æ¿Ÿå¤§æ¦‚éƒ½åœ¨è™•ç†é€™äº›å•é¡Œ

__å¹¸å¥½__ï¼š

+ åœ¨å•†æ¥­æ•¸æ“šåˆ†æè£¡é¢é€šå¸¸æˆ‘å€‘æ¯”è¼ƒé—œå¿ƒç›®æ¨™è®Šæ•¸çš„é æ¸¬å€¼($\hat{y}$)ï¼Œé€™éƒ¨åˆ†æ¯”è¼ƒæ²’æœ‰å•é¡Œ

<br><hr>

### [B] ä¿‚æ•¸çš„åˆ†å¸ƒ(æ©Ÿç‡å¯†åº¦å‡½æ•¸)

```{r fig.width=8, fig.height=4.5, fig.align="center"}
vx = c(3:5,7); cx = summary(m1)$coef  
par(cex=0.8)
plot(0,0,xlim=c(-0.04,0.02),ylim=c(0,800),pch=20,
     xlab="coefficients: the estimated value of b's",
     ylab='probability density',
     main='Probability Density Function of Coefficients')
abline(h=seq(0,800,100),v=seq(-0.04,0.03,0.0025),col='lightgray',lty=3)
for(i in vx) curve(dnorm(x,cx[i,1],cx[i,2]),add=T,col=i,lwd=2,n=1000)
abline(v=0,col='red')
legend("topleft",col=vx,lwd=2,legend=paste0(
  "b",vx," ( ",rownames(cx)[vx]," )", c("**","","ã€‚","***") ) )

summary(m1)$coef[vx,]
```

<p class="qiz">
<span style="font-size:24px">`r "\U1F5FF"` è¨è«–å•é¡Œï¼š</span><br>
&emsp; 1.ä¾æ“šé€™å€‹æ¨¡å‹ï¼Œåœ¨`CO2`ã€`CH4`ã€`N2O`ã€`CFC12`ä¹‹ä¸­ï¼š<br>
&emsp; &emsp; â–  å“ªä¸€ç¨®æ°£é«”çš„æ•ˆæœ(é—œä¿‚)ä¼°è¨ˆå€¼æœ€å¤§ï¼Ÿ å®ƒçš„æ•ˆæœæ˜¯é¡¯è‘—çš„å—ï¼Ÿ<br>
&emsp; &emsp; â–  å“ªä¸€ç¨®æ°£é«”çš„æ•ˆæœæœ€é¡¯è‘—ï¼Ÿ å®ƒçš„æ•ˆæœä¼°è¨ˆå€¼æ˜¯æœ€å¤§çš„å—ï¼Ÿ<br>
&emsp; &emsp; â–  é™¤äº†ä¿‚æ•¸çš„ä¼°è¨ˆå€¼ä¹‹å¤–ï¼Œé‚„æœ‰ä»€éº¼å› ç´ æœƒå½±éŸ¿è‡ªè®Šæ•¸çš„é¡¯è‘—æ€§ï¼Ÿ<br>
&emsp; 2.å¦‚æœæ¨£æœ¬è®Šå¤§çš„è©±ï¼š<br>
&emsp; &emsp; â–  ä¿‚æ•¸çš„ä¼°è¨ˆå€¼æœƒ(a)è®Šå¤§ã€(b)è®Šå°ã€æˆ–(c)ä¸è®Šï¼Ÿ<br>
&emsp; &emsp; â–  ä¿‚æ•¸çš„ä¼°è¨ˆæ¨™æº–å·®æœƒ(a)è®Šå¤§ã€(b)è®Šå°ã€æˆ–(c)ä¸è®Šï¼Ÿ <br>
&emsp; &emsp; â–  è‡ªè®Šæ•¸çš„$p$-valueæœƒ(a)è®Šå¤§ã€(b)è®Šå°ã€æˆ–(c)ä¸è®Šï¼Ÿ<br>
&emsp; &emsp; â–  è‡ªè®Šæ•¸çš„é¡¯è‘—æ€§æœƒ(a)è®Šå¤§ã€(b)è®Šå°ã€æˆ–(c)ä¸è®Šï¼Ÿ<br>
</p class="qiz"><br>
<br><hr>

### [C] è‡ªè®Šæ•¸ä¹‹é–“çš„ç›¸é—œæ€§ã€è¤‡å›æ­¸çš„å…±ç·šæ€§å•é¡Œ
ğŸŒ» è‡ªè®Šæ•¸ä¹‹é–“çš„ç›¸é—œæ€§éé«˜ï¼Œå¯èƒ½æœƒä½¿ä¿‚æ•¸çš„ä¼°è¨ˆå€¼æœ‰å¾ˆå¤§çš„åå·®
```{r}
cor(TR[3:10]) %>% round(2)
```

```{r fig.width=5, fig.height=5}
cor(TR[3:10]) %>% corrplot.mixed(tl.cex=0.7, tl.col='black')
```
<br><hr>

### [D] æ¨¡å‹é¸æ“‡ã€æŒ‘é¸è®Šæ•¸
ğŸŒ» æ‰€ä»¥æˆ‘å€‘å¸¸æŠŠç›¸é—œæ€§å¤ªé«˜çš„è‡ªè®Šæ•¸å¾æ¨¡å‹ä¸­ç§»é™¤
```{r}
m2 = lm(Temp~MEI+N2O+TSI+Aerosols,TR)  # æ‰‹å‹•æŒ‘é¸è‡ªè®Šæ•¸
summary(m2)
```

ğŸŒ» `R`èªè¨€è£¡é¢ä¹Ÿæœ‰ä¸€å€‹è‡ªå‹•æŒ‘é¸è®Šæ•¸çš„å…§å»ºå‡½æ•¸`step()`
```{r}
m3 = step(m1)   # è‡ªå‹•æŒ‘é¸è‡ªè®Šæ•¸
summary(m3)
```
<br><hr>

### [E] èª¤å·®èˆ‡æº–ç¢ºæ€§æŒ‡æ¨™

+ åŸºç¤æ¨¡å‹çš„å·®æ–¹å’Œ(__SST__)ï¼š$\sum_i (y_i-\bar{y})^2$

+ å›æ­¸æ¨¡å‹çš„å·®æ–¹å’Œ(__SSE__)ï¼š$\sum_i (\hat{y_i}-y_i)^2$ 

+ åˆ¤å®šä¿‚æ•¸($R^2$)ï¼š$1 - \frac{SSE}{SST}$

+ å¹³å‡èª¤å·®(__RMSE__)ï¼š$\sqrt{SSE/n}$

<br>

##### Â§ E1 ä½¿ç”¨ __è¨“ç·´è³‡æ–™__ åšé æ¸¬
```{r}
pred =  predict(m3)                     # ä½¿ç”¨è¨“ç·´è³‡æ–™åšé æ¸¬
SSE = sum((pred - TR$Temp)^2)           # SSE.train
SST = sum((mean(TR$Temp) - TR$Temp)^2)  # SST.train
R2 = 1 - SSE/SST                        # R2.train
RMSE = sqrt(SSE/nrow(TR))               # RMSE.train
c(SSE, SST, R2, RMSE)
```
<br>

##### Â§ E2 ä½¿ç”¨ __æ¸¬è©¦è³‡æ–™__ åšé æ¸¬
```{r}
pred =  predict(m3, TS)                 # ä½¿ç”¨æ¸¬è©¦è³‡æ–™åšé æ¸¬
SSE = sum((pred - TS$Temp)^2)           # SSE.test
SST = sum((mean(TR$Temp) - TS$Temp)^2)  # SST.test
R2 = 1 - SSE/SST                        # R2.test
RMSE = sqrt(SSE/nrow(TS))               # RMSE.test
c(SSE, SST, R2, RMSE)
```
æ³¨æ„ä¸€ä¸‹ï¼Œæˆ‘å€‘è¨ˆç®— __æ¸¬è©¦è³‡æ–™__ çš„å·®æ–¹å’Œæ˜¯ä½¿ç”¨ __è¨“ç·´è³‡æ–™__ çš„å¹³å‡å€¼åšåŸºæº–

$$ SST_{test} = \sum_{i=1}^n(\bar{y}_{train} - y_{i,test})^2$$
æ‰€ä»¥ $R_{test}^2$ æœ‰å¯èƒ½æœƒå°æ–¼é›¶ã€‚

<br>

<p class="qiz">
<span style="font-size:24px">`r "\U1F5FF"` è¨è«–å•é¡Œï¼š</span><br>
&emsp; 3.åœ¨å•†å‹™æ•¸æ“šåˆ†æçš„è§’åº¦ï¼Œæˆ‘å€‘æ‡‰è©²é—œå¿ƒçš„æ˜¯è‡ªè®Šæ•¸çš„ï¼š<br>
&emsp; &emsp; â–  ä¿‚æ•¸ä¼°è¨ˆå€¼<br>
&emsp; &emsp; â–  $p$-value<br>
&emsp; &emsp; â–  é¡¯è‘—æ€§<br>
&emsp; &emsp; â–  å…¶ä»–ï¼Œè«‹èªªæ˜ç‚ºç”šéº¼ï¼Ÿ<br>
</p class="qiz"><br>

<br><br><br><hr>



