---
title: TF3_é¡§å®¢ã€ç”¢å“ã€ç‡Ÿæ”¶ã€ç²åˆ© 
author: å“é›ç„¶, ä¸­å±±å¤§å­¸ ç®¡ç†å­¸è¡“ç ”ç©¶ä¸­å¿ƒ
date: "`r Sys.time()`"
output:
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
editor_options: 
  chunk_output_type: inline
---


```{r results='hide', message=FALSE, warning=FALSE, echo=F}
# Installation, setup & formatting. Do not modify this code chunk.  
rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE) 
options(scipen=20, digits=5, width=80, tibble.print_min=4)
rmarkdown::find_pandoc(version = '2.7.3')

if(!require(heatmaply)) install.packages("heatmaply")
if(!require(morpheus)) devtools::install_github('cmap/morpheus.R')
```

<br>

### ğŸ¦‹ å­¸ç¿’é‡é» 

<br>

ğŸŒ· **æ¸…ç†ã€å½™ç¸½èˆ‡çµ±è¨ˆ**

+ è³‡æ–™æ•´ç†çš„é‡é»(æ²’æœ‰ä¹‹ä¸€)åœ¨æ–¼ï¼š<z>ä¾æ“šåˆ†æå°è±¡å½™ç¸½è³‡æ–™</z>
+ åˆ†æå°è±¡å¯ä»¥æ˜¯ï¼šé¡§å®¢ã€é¡§å®¢æ—ç¾¤ã€å“é¡ã€å“é …ç­‰ç­‰
  + å°‡æ¯ä¸€å€‹åˆ†æå°è±¡æ•´ç†æˆä¸€å€‹è³‡æ–™æ¡†ï¼Œ
  + å…¶ä¸­æ¯ä¸€ç­†è³‡æ–™ä»£è¡¨ä¸€å€‹åˆ†æå°è±¡ï¼Œ
  + æ¯ä¸€å€‹æ¬„ä½ä»£è¡¨åˆ†æå°è±¡çš„1å€‹å±¬æ€§ï¼Œ
  + å¸¸è¦‹çš„å•†æ¥­åˆ†æå±¬æ€§ï¼šç‡Ÿæ”¶ã€ç²åˆ©ã€ç²åˆ©ç‡ã€åƒ¹æ ¼ã€æ•¸é‡ã€æ—¥æœŸã€æ—ç¾¤å¤§å°ç­‰ç­‰
+ è§€å¯Ÿå„åˆ†æå°è±¡/å±¬æ€§(è³‡æ–™æ¡†/æ¬„ä½)çš„åˆ†ä½ˆï¼Œæœ‰åŠ©æ–¼äº†è§£ç¶“ç‡Ÿç‹€æ³

<br>

ğŸŒ· **åˆ†ç¾¤çµ±è¨ˆèˆ‡æ¯”è¼ƒ**

+ æˆ‘å€‘å¯ä»¥åˆ©ç”¨æ—¢æœ‰çš„é¡åˆ¥è®Šæ•¸åšåˆ†ç¾¤ (eg., `age`, `area`)
+ é€éåˆ†ç¾¤çµ±è¨ˆèˆ‡æ¯”è¼ƒï¼Œå°±å¯ä»¥æ‰¾åˆ°å„æ—ç¾¤çš„ç‰¹å¾µèˆ‡é‡è¦æ€§ 
+ æ—ç¾¤é‡è¦æ€§(ç‡Ÿæ”¶/ç²åˆ©è²¢ç»)å¯ä»¥å¹«åŠ©æˆ‘å€‘è¨­å®šç­–ç•¥é‡é»
+ æ—ç¾¤ç‰¹å¾µå¯ä»¥å¹«åŠ©æˆ‘å€‘è¦åŠƒæ”¹é€²æ–¹æ¡ˆ

<br>
 
ğŸŒ· **å¤šè®Šé‡åˆ†æ**

+ è§€å¯Ÿå–®ä¸€è®Šæ•¸çš„åˆ†ä½ˆä¹‹å¾Œï¼Œé€²ä¸€æ­¥çš„åˆ†æé€šå¸¸ç‰½æ¶‰åˆ°å¤šè®Šæ•¸ä¹‹é–“çš„é—œè¯æ€§
+ åˆ†æå°è±¡æ•¸é‡å¤ªå¤šçš„æ™‚å€™ï¼Œæˆ‘å€‘å¯ä»¥åšé›†ç¾¤åˆ†æ
+ éœ€è¦æ¯”è¼ƒçš„è®Šæ•¸å¤ªå¤šçš„æ™‚å€™ï¼Œæˆ‘å€‘å¯ä»¥åšå°ºåº¦ç¸®æ¸›
+ äº’å‹•å¼çš„è³‡æ–™è¦–è¦ºåŒ–å¯ä»¥å¹«åŠ©æˆ‘å€‘åŒæ™‚æ¯”è¼ƒå¾ˆå¤šå°è±¡(æ—ç¾¤)çš„å¾ˆå¤šå€‹å±¬æ€§

<br><hr>

<br>
```{r echo=T, message=F, cache=F, warning=F}
rm(list=ls(all=TRUE))
pacman::p_load(ggplot2,dplyr,heatmaply)
load("data/tf0.rdata")
sapply(list(cust=A0,tid=X0,items=Z0), nrow)
```
<br>


### å“é …èˆ‡å“é¡ çš„ ç‡Ÿæ”¶èˆ‡ç²åˆ©

```{r}
Z0 %>% summarise_at(vars(cust,prod,cat),n_distinct)
```

##### å“é¡åˆ†æ

ç²åˆ©è²¢ç»(`profit`)æœ€å¤§çš„100å€‹å“é¡(`cat`)
```{r fig.height=3.5, fig.width=5.5}
col6 = c('seagreen','gold','orange',rep('red',3))
gg= group_by(Z0, cat) %>% summarise(
  solds = n(), qty = sum(qty), rev = sum(price), cost = sum(cost), 
  profit = rev - cost, margin = 100*profit/rev
  ) %>% 
  top_n(100, profit) %>% 
  ggplot(aes(x=margin, y=rev, col=profit, label=cat)) + 
  geom_point(size=2,alpha=0.8) + scale_y_log10() + 
  scale_color_gradientn(colors=col6) +
  theme_bw()
ggplotly(gg)
```

<span style="font-size:18px"> ğŸš´  ç·´ç¿’ </span><br>
åˆ©ç”¨ä»¥ä¸Šçš„ç¨‹å¼ ...

+ ç”¨åœ–å½¢å‘ˆç¾ï¼Œç‡Ÿæ”¶è²¢ç»(`rev`)æœ€å¤§çš„100å€‹å“é¡(`cat`),æ’é™¤è² æ¯›åˆ©çš„å“é¡  
+ ä¸€èˆ¬è€Œè¨€ï¼Œç‡Ÿæ”¶è¼ƒå¤§çš„å“é¡ï¼Œç²åˆ©ä¹Ÿæ¯”è¼ƒå¤§ï¼Œå°å—ï¼Ÿ 
+ é€™å…©å€‹åœ–å½¢çš„æ¨£æ…‹æ˜¯é¡ä¼¼çš„å—ï¼Ÿ

```{r fig.height=3.5, fig.width=5.5, echo=F}
gg= group_by(Z0, cat) %>% summarise(
  solds = n(), 
  qty = sum(qty),
  rev = sum(price),
  cost = sum(cost),
  profit = rev - cost,
  margin = 100*profit/rev
  ) %>% 
  top_n(100, rev) %>% filter(margin > 0) %>% 
  ggplot(aes(x=margin, y=rev, col=profit, label=cat)) + 
  geom_point(size=2,alpha=0.8) + scale_y_log10() + 
  scale_color_gradientn(colors=col6) +
  theme_bw() 
ggplotly(gg)
```


<br><br>


##### å“é …åˆ†æ


<span style="font-size:18px"> ğŸš´  ç·´ç¿’ </span><br>
åˆ©ç”¨ä»¥ä¸Šçš„ç¨‹å¼ ...

+ ç”¨åœ–å½¢å‘ˆç¾ï¼Œç²åˆ©è²¢ç»(`profit`)æœ€å¤§çš„300å€‹ã€å“é …(`prod`)ã€
+ ç‡Ÿæ”¶(`rev`)å’Œç²åˆ©ç‡ä¹‹é–“æœ‰ç›¸é—œæ€§å—ï¼Ÿ 
+ ç”¨åœ–å½¢å‘ˆç¾ï¼Œç‡Ÿæ”¶è²¢ç»(`rev`)æœ€å¤§çš„300å€‹ã€å“é …(`prod`)ã€ 
+ é€™å…©å€‹åœ–å½¢çš„æ¨£æ…‹æ˜¯é¡ä¼¼çš„å—ï¼Ÿ

```{r fig.height=3.5, fig.width=7.5, echo=F}
df = group_by(Z0, prod) %>% summarise(
  solds=n(), qty=sum(qty), rev=sum(price), cost=sum(cost),
  profit = rev - cost, margin = 100*profit/rev)  
L = lapply(c("profit","rev"), function(z) {
  top_n(df, 300, df[,z,T]) %>% filter(margin > 0) %>% 
    ggplot(aes(x=margin, y=rev, col=profit, label=prod)) + 
    geom_point(size=1.5,alpha=0.8) + scale_y_log10(limits=c(1e4,1e6)) + 
    scale_color_gradientn(colors=col6) + theme_bw() +
    geom_text(aes(x=15,y=1e6,label=paste("top-300",z)),color="black")
  } ) 
subplot(L)
```
<br><br>


### é¡§å®¢ çš„ ç‡Ÿæ”¶èˆ‡ç²åˆ©

##### Top500é¡§å®¢

```{r fig.height=3.5, fig.width=5.5}
a500 = A0 %>% top_n(500, raw)
g = ggplot(a500, aes(x=m, y=f, col=raw)) + 
  geom_point(size=2, alpha=0.8) +
  scale_x_log10() + scale_color_gradientn(colors=col6) + 
  theme_bw()
ggplotly(g)
```


<br><br>


### é¡§å®¢æ—ç¾¤ çš„ ç‡Ÿæ”¶èˆ‡ç²åˆ©

##### ä¾è³¼è²·è¡Œç‚ºåˆ†ç¾¤
æ‰¾å‡ºæœ€å¤šäººè²·çš„`M=50`å€‹å“é¡
```{r}
M=50
cm = Z0 %>% group_by(cat) %>% summarise(r = n_distinct(cust)/nrow(A0)) %>% 
  arrange(desc(r)) %>% pull(cat) %>% head(M)
```

åšå‡º é¡§å®¢xå“é¡ çŸ©é™£ - `x`
```{r}
x = xtabs(~cust+cat, filter(Z0, cat%in%cm)) %>% as.data.frame.matrix
x = x[,order(-colSums(x))]
dim(x)
```

ç”¨k-meansåšåˆ†ç¾¤ - `K=160`
```{r}
K=160
set.seed(1111)
kg = kmeans(x, K, iter.max=30)$cluster 
table(kg) %>% sort
```

ç”¨äº’å‹•åœ–è¡¨æ‰¾å‡ºé‡é»æ—ç¾¤
```{r message=F, fig.height=4, fig.width=6.5}
ckg = tibble(cust=rownames(x),kg=kg)
gdf = inner_join(A0, ckg) %>% 
  group_by(kg) %>% summarise(
  gsize = n(), ttRev = sum(rev), ttProfit = sum(raw),
  avRev = mean(rev), avProfit = mean(raw),
  avRecent = mean(r), avFreq = mean(f), avMoney = mean(m)
  )  
filter(gdf, gsize >= 200, gsize <= 1000) %>% 
  ggplot(aes(avMoney,avFreq,col=ttProfit,size=gsize,label=kg)) + 
  geom_point(alpha=0.6) +
  scale_color_gradientn(colors=c("seagreen","gold","tomato")) +
  theme_bw() -> g
ggplotly(g)
```

ç”¨ç†±åœ–æ‰¾å‡ºå„æ—ç¾¤çš„è³¼è²·æ¨£æ…‹
```{r}
color9 = c("darkblue","green","gold","orange",rep("red",5))
hmap1 = function(x, ...) { heatmaply(
  as.data.frame.matrix(x), cexRow=0.7, cexCol=0.7, 
  grid_color='gray70', ...)
  }  
```

```{r warning=F}
g = filter(gdf, gsize >= 200, gsize <= 800) %>% pull(kg)
# g:äººæ•¸å¤§æ–¼200ã€å°æ–¼800çš„æ—ç¾¤
a = sapply(split(x[kg %in% g,1:30], kg[kg %in% g]), colMeans)
# é€™äº›æ—ç¾¤å°éŠ·å”®æ•¸æœ€å¤šçš„å‰30å€‹å“é¡çš„å¹³å‡è³¼è²·æ¬¡æ•¸
hmap1(a, col=color9, show_dendrogram=c(F,F))
```

##### RFMçŸ©é™£ è¦å‰‡åˆ†ç¾¤

åœ¨é¡§å®¢è³‡æ–™æ¡†åŠ å…¥è¦å‰‡åˆ†ç¾¤æ¬„ä½
```{r}
bm = c(0, quantile(A0$m,c(.25,0.5,.75)), max(A0$m)+100)
bf = c(0, quantile(A0$f,c(.25,0.5,.75)), max(A0$f)+100)
A = A0 %>% mutate(
  mx = cut(A0$m, bm, labels=paste0('M',1:4)),
  fx = cut(A0$f, bf, labels=paste0('F',1:4)),
  MF = paste0(mx, fx)
  )
table(A$mx, A$fx)
```

æ‰¾å‡ºç‡Ÿæ”¶æœ€å¤§çš„å“é¡
```{r}
cat100 = count(Z0, cat, wt=price, sort=T) %>% mutate(
  pc=n/sum(n), cum.pc=cumsum(pc)) %>% head(100)
cat100[c(1:5,96:100), ]
```


åšå‡º é¡§å®¢æ—ç¾¤xå“é¡ è³¼è²·é‡‘é¡çŸ©é™£ 
```{r}
Z = inner_join(Z0, A[,c('cust','MF')])
mx0 = xtabs(price~MF+cat, filter(Z, cat %in% cat100$cat[1:30]))
dim(mx0)
```


ä¾è³¼è²·é‡‘é¡çŸ©é™£è£½ä½œç†±åœ– 
```{r}
hmap1(mx0, col=cool_warm)
```

ğŸŒ· **æ­£è¦åŒ– - è³¼è²·æ¯”ä¾‹çŸ©é™£**
```{r}
mx1 = mx0/rowSums(mx0)
hmap1(mx1, col=cool_warm)
```

ç†±åœ–çš„åˆ†ç¾¤åŠŸèƒ½
```{r}
mx2 = xtabs(price~MF+cat, filter(Z, cat %in% cat100$cat[1:20]))
mx3 = 100*mx2/rowSums(mx2)
hmap1(mx3, col=cool_warm, show_dendrogram=c(T,F),k_row=5)
```


<br><br>

### å­¸ç¿’é‡é»

<p class="wwl">
<span style="font-size:20px">`r "\U1F4A1"` ã€ŒçŸ©é™£ã€èˆ‡ã€Œç†±åœ–ã€ </span><br>
â–  ä¾å…©é¡åˆ¥è®Šæ•¸åšåˆ†é¡çµ±è¨ˆï¼Œå°±æœƒç”¢ç”ŸçŸ©é™£<br>
â–  ç†±åœ–æ˜¯çŸ©é™£è³‡æ–™çš„è¦–è¦ºåŒ–å·¥å…·<br>
â–  ç†±åœ–ä¸åªæ˜¯ç”¨é¡è‰²ä»£è¡¨æ•¸å€¼è€Œå·²<br>
â–  å®ƒå¯ä»¥å°çŸ©é™£çš„æ¬„èˆ‡åˆ—åšé›†ç¾¤åˆ†æï¼Œåˆ†åˆ¥å°‡å…©å€‹é¡åˆ¥è®Šæ•¸ä¹‹ä¸­ç›¸ä¼¼çš„åˆ†é¡æ’¿åœ¨ä¸€èµ·<br>
â–  å°æ•¸è½‰æ›å¯ä»¥é™ä½æ¥µç«¯(é›¢ç¾¤))å€¼çš„å½±éŸ¿ï¼Œè®“ç†±åœ–çš„é¡è‰²æ›´æœ‰å€è¾¨æ•ˆæœ<br>
â–  ç‚ºäº†**å»ºç«‹æ¯”è¼ƒåŸºç¤**å’Œ**åŠ å¼·è¦–è¦ºæ•ˆæœ**ï¼Œæœ‰æ™‚æˆ‘å€‘éœ€è¦å…ˆå°çŸ©é™£çš„æ¬„ã€åˆ—æˆ–æ•´å€‹çŸ©é™£åšè½‰åŒ–<br>
</p class="wwl"><br>

<p class="wwl">
<span style="font-size:20px">`r "\U1F4A1"` ã€Œæ¯”è¼ƒåŸºç¤ã€å’Œã€Œæ•¸å€¼æ•£ä½ˆã€</span><br>
â–  åˆ†æå…¶å¯¦å°±æ˜¯åšæ¯”è¼ƒï¼Œè€Œæ¯”è¼ƒéœ€è¦æœ‰ï¼šã€Œæ¯”è¼ƒåŸºç¤ã€å’Œã€Œå¯æ¯”è¼ƒæ€§ã€<br>
â–  è³‡æ–™è½‰æ›é€šå¸¸æ˜¯ç‚ºäº†è§£æ±ºã€Œæ¯”è¼ƒåŸºç¤ã€å’Œã€Œæ•¸å€¼æ•£ä½ˆã€é€™å…©å€‹å•é¡Œ<br>
â–  ç•¶è¦æ¯”è¼ƒ(æˆ–è¦–è¦ºåŒ–)çš„æ•¸å€¼ä¹‹é–“å¤§å°ç›¸è·å¾ˆå¤§çš„æ™‚å€™ï¼Œå¯ä»¥è€ƒæ…®ï¼š<br>
&emsp; &emsp; Â§ å°‡æ•¸å€¼è½‰åŒ–ç‚ºæ¯”ç‡<br>
&emsp; &emsp; Â§ åšå°æ•¸è½‰æ› (`log10()`)<br>
&emsp; &emsp; Â§ è¨­å®šæ•¸å€¼ç¯„åœ (`pmin()`,`pmax()`)<br>
&emsp; &emsp; Â§ æ¨™æº–åŒ– (standardization)<br>
&emsp; &emsp; Â§ æ­£è¦åŒ– (normalization)<br>
&emsp; &emsp; Â§ æ¨™æº–åŒ–æ®˜å·®çŸ©é™£ (standardization)<br>
</p class="wwl"><br>

<p class="wwl">
<span style="font-size:20px">`r "\U1F4A1"` ã€Œæ­£è¦åŒ–ã€å’Œã€Œæ¨™æº–åŒ–ã€</span><br>
åŸºæº–åŒ–æœ‰å…©ç¨®ä½œæ³•ï¼š<br>
&emsp; â–  æ­£è¦åŒ–(Normalization)æ¯”è¼ƒé‡è¦–æ¯”ä¾‹ï¼Œå®ƒçš„å€¼æ˜¯å–®å‘çš„(å¾0åˆ°1)ï¼›<br>
&emsp; â–  æ¨™æº–åŒ–(Standardization)æ¯”è¼ƒé‡è¦–è®Šç•°ï¼Œå®ƒçš„å€¼æ˜¯é›™å‘çš„ï¼Œä»¥0ç‚ºåŸºæº–ã€ä»¥æ¨™æº–å·®ç‚ºå–®ä½
</p class="wwl"><br>

<br><br>



