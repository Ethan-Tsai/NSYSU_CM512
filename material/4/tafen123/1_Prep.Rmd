---
title: TF1_è³‡æ–™å½™æ•´ 
author: å“é›ç„¶, ä¸­å±±å¤§å­¸ ç®¡ç†å­¸è¡“ç ”ç©¶ä¸­å¿ƒ
date: "`r Sys.time()`"
output:
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
---
<br>

### è³‡æ–™å½™æ•´æµç¨‹

<center>
![Fig-1:äº¤æ˜“è³‡æ–™å½™æ•´](fig/aggregation.jpg)
</center>

<hr>

### 1. äº¤æ˜“é …ç›®è¨ˆéŒ„ï¼š`Z`

```{r setup, echo=T, message=F, cache=F, warning=F}
rm(list=ls(all=T))
knitr::opts_chunk$set(paged.print=FALSE, comment = NA)
pacman::p_load(magrittr, readr, caTools, ggplot2, dplyr, vcd)
```

##### 1.1 è®€é€²è³‡æ–™
```{r}
Z = read_csv("data/ta_feng_all_months_merged.csv") %>% 
  data.frame %>% setNames(c(
    "date","cust","age","area","cat","prod","qty","cost","price"))
nrow(Z)
```

```{r}
tibble(Z)
```

##### æ—¥æœŸæ ¼å¼è½‰æ›
```{r fig.height=3.2, fig.width=7}
Z$date = as.Date(Z$date, format="%m/%d/%Y")
par(cex=0.8)
hist(Z$date,'weeks',freq=T,las=2)
```

##### å¹´é½¡å±¤ç´šã€éƒµéå€è™Ÿ
```{r}
age.group = c("<25","25-29","30-34","35-39","40-44",
              "45-49","50-54","55-59","60-64",">65")
Z$age = c(paste0("a",seq(24,69,5)),"a99")[match(Z$age,age.group,11)]
Z$area = paste0("z",Z$area)
```

<center>
![Fig-2:éƒµéå€è™Ÿ](fig/zipcode.png)
</center>


```{r fig.height=2.5, fig.width=7}
par(mfrow=c(1,2),cex=0.7)
table(Z$age, useNA='ifany') %>% barplot(main="Age Groups", las=2)
table(Z$area,useNA='ifany') %>% barplot(main="Areas", las=2)
```

##### è™•ç†é›¢ç¾¤å€¼
```{r}
# Quantile of Variables
sapply(Z[,7:9], quantile, prob=c(.99, .999, .9995))
```

```{r}
# Remove Outliers
Z = subset(Z, qty<=24 & cost<=3800 & price<=4000) 
nrow(Z)  
```

##### å½™ç¸½è¨‚å–® Assign Transaction ID
æŠŠæ¯ä¸€å¤©ã€æ¯ä¸€ç‚ºé¡§å®¢çš„äº¤æ˜“é …ç›®å½™ç¸½ç‚ºä¸€å¼µè¨‚å–®
```{r}
Z$tid = group_indices(Z, date, cust) # same customer same day
```

##### è³‡æ–™ç¸½è¦½
```{r}
# No. cust, cat, prod, tid
sapply(Z[c("cust","cat","prod","tid")], n_distinct)
```
<br><hr>

### 2. äº¤æ˜“è¨ˆéŒ„ï¼š`X`

##### äº¤æ˜“è³‡æ–™å½™æ•´
```{r}
X = Z %>% group_by(tid) %>% summarise(
  date = min(date),          # äº¤æ˜“æ—¥æœŸ  
  cust = min(cust),          # é¡§å®¢ ID
  age = min(age),            # é¡§å®¢ å¹´é½¡ç´šåˆ¥
  area = min(area),          # é¡§å®¢ å±…ä½å€åˆ¥
  items = n(),               # äº¤æ˜“é …ç›®(ç¸½)æ•¸
  pieces = sum(qty),         # ç”¢å“(ç¸½)ä»¶æ•¸
  total = sum(price),        # äº¤æ˜“(ç¸½)é‡‘é¡
  gross = sum(price - cost)  # æ¯›åˆ©
) %>% data.frame
nrow(X) # 119422 
```

##### è™•ç†é›¢ç¾¤å€¼
```{r}
# Check Quantile & Remove Outliers
sapply(X[,6:9], quantile, prob=c(.999, .9995, .9999))
```

```{r}
# Remove Outliers
X = subset(X, items<=62 & pieces<95 & total<16000) # 119328
```

##### äº¤æ˜“æ‘˜è¦
```{r}
summary(X)    
```

##### æ¯å‘¨äº¤æ˜“æ¬¡æ•¸
```{r fig.height=3, fig.width=7}
par(cex=0.8)
hist(X$date, "weeks", freq=T, las=2, main="No. Transaction per Week")
```
<br><hr>

### 3. é¡§å®¢è³‡æ–™ï¼š`A`

##### é¡§å®¢è³‡æ–™å½™æ•´
```{r}
d0 = max(X$date) + 1
A = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
  ) %>% group_by(cust) %>% summarise(
    r = min(days),      # recency
    s = max(days),      # seniority
    f = n(),            # frquency
    m = mean(total),    # monetary
    rev = sum(total),   # total revenue contribution
    raw = sum(gross),   # total gross profit contribution
    age = min(age),     # age group
    area = min(area),   # area code
  ) %>% data.frame      
nrow(A) # 32241
```

```{r fig.height=2.5, fig.width=7.2}
par(mfrow=c(1,2),cex=0.7)
table(A$age, useNA='ifany') %>% barplot(main="Age Groups",las=2)
table(A$area, useNA='ifany') %>% barplot(main="Areas",las=2)                
```

##### é¡§å®¢æ‘˜è¦
```{r}
summary(A) 
```

```{r fig.height=8}
par(mfrow=c(3,2), mar=c(3,3,4,2))
for(x in c('r','s','f','m')) 
  hist(A[,x],freq=T,main=x,xlab="",ylab="",cex.main=2)
hist(pmin(A$f,10),0:10,freq=T,xlab="",ylab="",cex.main=2)
hist(log(A$m,10),freq=T,xlab="",ylab="",cex.main=2)
```

ğŸŒ· **åæ…‹åˆ†ä½ˆçš„è™•ç†æ–¹æ³•**

+ å°æ•¸è½‰æ› - `log(A$m, 10)`
+ å›ºå®šä¸Šé™ - `pmin(A$f, 10)`

<br> 

##### Check & Save
```{r}
is.na(Z) %>% colSums
```

```{r}
is.na(X) %>% colSums
```

```{r}
is.na(A) %>% colSums
```

```{r}
A0 = A; X0 = X; Z0 = Z
save(Z0, X0, A0, file="data/tf0.rdata")
```

<br><hr>

### 4. è¡ŒéŠ·ä¼ç•«ç«¶è³½ 

##### A.ä¼ç•«é …ç›®

+ 1)åˆ©ç”¨æ—¢æœ‰å’Œè¡ç”Ÿçš„è®Šæ•¸åšé¡§å®¢åˆ†ç¾¤(æ¨™ç±¤)
+ 2)æ ¹æ“šé¡§å®¢æ—ç¾¤åƒ¹å€¼å±¬æ€§ï¼Œé¸å–è¡ŒéŠ·é‡é»ã€è¨­å®šè¡ŒéŠ·ç›®æ¨™
+ 3)è£½ä½œæ¨¡å‹ï¼šä¼°è¨ˆæ¯ä¸€ä½é¡§å®¢çš„ï¼š
    + å›è³¼æ©Ÿç‡
    + é æœŸç‡Ÿæ”¶ã€é æœŸç²åˆ©
    + çµ‚ç”Ÿåƒ¹å€¼
+ 4)æ ¹æ“šé¡§å®¢æ—ç¾¤ç‰¹å¾µï¼Œè¨­è¨ˆ(è‡³å°‘å…©é …)è¡ŒéŠ·æ–¹æ¡ˆ
+ 5)å°æ–¹æ¡ˆçš„æˆæœ¬ã€æ•ˆç›Šé€²è¡Œ(å¯ä»¥é€éåƒæ•¸èª¿æ•´çš„)å‡è¨­
+ 6)è¨­è¨ˆæ¨¡æ“¬ç¨‹å¼ï¼Œè—‰ä»¥ï¼š 
    + é¸æ“‡è¡ŒéŠ·æ–¹æ¡ˆ
    + è¨­å®šæ–¹æ¡ˆåƒæ•¸
    + é¸æ“‡è¡ŒéŠ·å°è±¡
    + ä¼°è¨ˆæˆæœ¬æ•ˆç›Š
+ 7)åšä¸€å€‹å®Œæ•´çš„è¡ŒéŠ·ä¼åŠƒå ±å‘Šï¼š
    + ç¶“ç‡Ÿç¾æ³
    + æ”¹å–„ç­–ç•¥
    + è¡ŒéŠ·æ–¹æ¡ˆ
    + é æœŸæˆæ•ˆ

##### B.è©•åˆ†é …ç›®

1) èƒ½å¾è³‡æ–™ä¸­æ‰¾å‡ºé‡è¦çš„ç¾è±¡ã€çµæ§‹ã€è¶¨å‹¢
2) èƒ½å–„ç”¨è³‡æ–™è¦–è¦ºåŒ–å‘ˆç¾é‡è¦ç™¼ç¾
3) èƒ½æ‰¾å‡ºç‰¹æ®Šçš„ã€æœ‰åƒ¹å€¼çš„é¡§å®¢æ—ç¾¤
4) èƒ½æ‰¾åˆ°æˆ–å°å‡ºæœ‰é æ¸¬åŠ›çš„è®Šæ•¸
5) èƒ½æ ¹æ“šåˆ†æçš„çµæœé¸æ“‡ç­–ç•¥é‡é»ã€è¨­å®šç­–ç•¥(é‡åŒ–)ç›®æ¨™
6) èƒ½æå‡ºæœ‰æ•ˆã€æœ‰å‰µæ„çš„è¡ŒéŠ·æ–¹æ¡ˆ
7) èƒ½è¨­è¨ˆå‡ºåˆç†çš„å‡è¨­
8) èƒ½æ­£ç¢ºæ¼”ç·´å¸‚å ´æ¨¡æ“¬çš„ç¨‹åºï¼Œæ¸…æ¥šè¡¨é”ç­–ç•¥è¦åŠƒçš„é‚è¼¯
9) æ•´ä»½è¡ŒéŠ·ä¼åŠƒçš„æ•´é«”(å½±ç‰‡+æ–‡æ¡ˆ)å“è³ª
10) æŠ•å…¥è³‡æºåŸ·è¡Œé€™ä¸€ä»½ä¼åŠƒçš„æ„é¡˜

<br><hr>

### 5. è³‡æ–™æ¢ç´¢ç·´ç¿’

+ 1)ä¸åŒçš„å¹´é½¡(æˆ–åœ°ç†)æ—ç¾¤çš„è³¼è²·è¡Œç‚ºæœ‰ä»€éº¼å·®ç•°
+ 2)é¡§å®¢åœ¨å‘¨æœ«å’Œå‘¨é–“çš„è³¼è²·è¡Œç‚ºæ˜¯ä¸€æ¨£çš„å—
+ 3)è³£çš„æœ€å¥½çš„å“é¡(å“é …) 
+ 4)éŠ·å”®é‡æˆ–ç‡Ÿæ”¶æœ€å¤§çš„å“é¡(å“é …)ç²åˆ©ä¹Ÿæ˜¯æœ€å¤§çš„å—
+ 5)ä¾æ“š ... åšé¡§å®¢åˆ†ç¾¤(å¸‚å ´å€éš”)
    + RFM
    + å¹´é½¡å±¤ã€å±…ä½åœ°å€
    + æ›¾è³¼è²·çš„ç”¢å“
    + ...
+ 6)æ¯”è¼ƒå„æ—ç¾¤çš„ç‰¹å¾µ
+ 7)...
+ 8)è¨­å®šè¡ŒéŠ·ç›®æ¨™å’Œç­–ç•¥ 

##### é¡åˆ¥è³‡æ–™çš„åˆ†é¡çµ±è¨ˆ
```{r fig.height=6, fig.width=7.5}
mosaic(~area+age, data=A, shade=T)
```

<br><br><br><br>